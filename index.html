<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Silent Bus Dashboard (Live)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>
  <style>
    body { font-family: system-ui, "Segoe UI", Arial; background:#f1f5f9; margin:20px; }
    h1 { text-align:center; }
    #board { display:flex; gap:16px; margin-top:12px; }
    .column { flex:1; background:white; border-radius:10px; padding:12px; min-height:400px; box-shadow:0 1px 4px rgba(0,0,0,0.08); }
    .column h2 { text-align:center; }
    .bus { background:#e6f0ff; margin:6px; padding:10px; border-radius:8px; cursor:grab; transition:transform 0.1s ease; }
    .bus.dragging { opacity:0.5; transform:scale(1.05); }
    button { padding:8px 16px; border:none; border-radius:6px; background:#2563eb; color:white; cursor:pointer; }
    button:hover { background:#1e40af; }
    #login, #soundPermission { display:flex; justify-content:center; margin:20px; }

    /* üîÑ Loading overlay */
    #loadingOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(241, 245, 249, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 1.5em;
      color: #2563eb;
      z-index: 1000;
    }
    .spinner {
      border: 4px solid #e0e7ff;
      border-top: 4px solid #2563eb;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      margin-right: 10px;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <h1>Silent Bus Dashboard ‚Äî Live</h1>

  <div id="login"><button onclick="signIn()">Sign in with Microsoft</button></div>
  <div id="soundPermission" style="display:none;"><button onclick="enableSounds()">Enable Sounds üîä</button></div>

  <div id="board" style="display:none;">
    <div class="column" id="Not Here"><h2>üöç Not Here</h2></div>
    <div class="column" id="On Deck"><h2>‚åö On Deck</h2></div>
    <div class="column" id="Here"><h2>‚úÖ Here</h2></div>
    <div class="column" id="Gone"><h2>üèÅ Gone</h2></div>
  </div>

  <!-- üéµ Sounds -->
  <audio id="soundHere" src="https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg" preload="auto"></audio>
  <audio id="soundOnDeck" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

  <!-- üîÑ Loading overlay -->
  <div id="loadingOverlay">
    <div class="spinner"></div>
    <span>Refreshing bus list‚Ä¶</span>
  </div>

  <script>
  const msalConfig = {
    auth: {
      clientId: "9fa63e7d-529b-4b31-aeba-240de53122e9",
      authority: "https://login.microsoftonline.com/9c6c3caa-8f3d-4f3c-98f7-e4feea479b7d",
      redirectUri: "https://aaleventhal-lev.github.io/silent-bus-dashboard/"
    },
    cache: { cacheLocation: "localStorage", storeAuthStateInCookie: false }
  };
  const msalInstance = new msal.PublicClientApplication(msalConfig);
  const accounts = msalInstance.getAllAccounts();
  if (accounts.length > 0) msalInstance.setActiveAccount(accounts[0]);

  let accessToken = null;
  const siteUrl = "https://thewatsoninstitute.sharepoint.com/sites/EdCenterSewickleyStaffResourceHub";
  const listName = "Silent Bus Admin List";
  const soundHere = document.getElementById("soundHere");
  const soundOnDeck = document.getElementById("soundOnDeck");

  // üîä Session-based sound permission
  function showSoundButton(){ document.getElementById("soundPermission").style.display = "block"; }
  function enableSounds(){
    soundHere.play().then(()=>soundHere.pause()).catch(()=>{});
    soundOnDeck.play().then(()=>soundOnDeck.pause()).catch(()=>{});
    document.getElementById("soundPermission").style.display = "none";
    sessionStorage.setItem("soundsEnabled", "true");
  }
  if (!sessionStorage.getItem("soundsEnabled")) showSoundButton();

  // üåÄ Loading overlay
  function showLoading(show){ document.getElementById("loadingOverlay").style.display = show ? "flex" : "none"; }

  async function signIn() {
    try {
      const loginResponse = await msalInstance.loginPopup({ scopes: ["User.Read", "Sites.Read.All"] });
      msalInstance.setActiveAccount(loginResponse.account);
      const tokenResponse = await msalInstance.acquireTokenSilent({ scopes: ["https://thewatsoninstitute.sharepoint.com/.default"], account: loginResponse.account });
      accessToken = tokenResponse.accessToken;
      document.getElementById("login").style.display = "none";
      document.getElementById("board").style.display = "flex";
      await loadListData();
    } catch(e){ console.error(e); }
  }

  let previousStatuses = {};
  let initialized = false;

  async function loadListData() {
    if (!accessToken) return;
    showLoading(true);
    const endpoint = `${siteUrl}/_api/web/lists/GetByTitle('${listName}')/items?$select=Id,Title,Status`;
    try {
      const resp = await fetch(endpoint, { headers:{ "Authorization":`Bearer ${accessToken}`, "Accept":"application/json;odata=nometadata" } });
      const data = await resp.json();
      const buses = data.value.map(item=>({id:item.Id, name:item.Title, status:item.Status||"Not Here"}));

      // üîä Play sounds on status change (skip initial load)
      if (initialized && sessionStorage.getItem("soundsEnabled")) {
        for (const bus of buses){
          const old = previousStatuses[bus.id];
          if(old && old!==bus.status){
            if(bus.status==="Here") { soundHere.pause(); soundHere.currentTime=0; soundHere.play().catch(()=>{}); }
            else if(bus.status==="On Deck") { soundOnDeck.pause(); soundOnDeck.currentTime=0; soundOnDeck.play().catch(()=>{}); }
          }
        }
      }

      previousStatuses = {}; for(const bus of buses){ previousStatuses[bus.id]=bus.status; }
      initialized = true;
      render(buses);

    } catch(e){ console.error(e); }
    finally{ showLoading(false); }
  }

  function render(buses){
    ["Not Here","On Deck","Here","Gone"].forEach(status=>{
      const col=document.getElementById(status);
      col.querySelectorAll(".bus").forEach(b=>b.remove());
      buses.filter(b=>b.status===status).forEach(bus=>{
        const div=document.createElement("div");
        div.className="bus";
        div.textContent=bus.name;
        div.draggable=true;
        div.dataset.id=bus.id;

        div.addEventListener("dragstart", e=>{ e.dataTransfer.setData("text/plain", bus.id); div.classList.add("dragging"); });
        div.addEventListener("dragend", ()=>div.classList.remove("dragging"));
        col.appendChild(div);
      });
    });

    document.querySelectorAll(".column").forEach(col=>{
      col.ondragover=e=>e.preventDefault();
      col.ondrop=async e=>{
        e.preventDefault();
        const id=e.dataTransfer.getData("text/plain");
        const bus=buses.find(b=>b.id==id);
        if(bus.status===col.id) return;
        bus.status=col.id;
        render(buses);
        if(sessionStorage.getItem("soundsEnabled")){
          if(col.id==="Here"){ soundHere.pause(); soundHere.currentTime=0; soundHere.play().catch(()=>{}); }
          else if(col.id==="On Deck"){ soundOnDeck.pause(); soundOnDeck.currentTime=0; soundOnDeck.play().catch(()=>{}); }
        }
        await updateListItem(bus);
      };
    });
  }

  async function updateListItem(bus){
    const endpoint=`${siteUrl}/_api/web/lists/GetByTitle('${listName}')/items(${bus.id})`;
    await fetch(endpoint,{
      method:"PATCH",
      headers:{
        "Authorization":`Bearer ${accessToken}`,
        "Accept":"application/json;odata=nometadata",
        "Content-Type":"application/json;odata=nometadata",
        "IF-MATCH":"*"
      },
      body:JSON.stringify({Status:bus.status})
    });
  }

  setInterval(async ()=>{
    const account=msalInstance.getActiveAccount();
    if(account && accessToken) await loadListData();
  },15000);

  </script>
</body>
</html>
