<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Silent Bus Dashboard - Cupples (Live)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>
  <style>
    body { font-family: system-ui, "Segoe UI", Arial; background:#f1f5f9; margin:14px; }
    h1 { text-align:center; margin: 6px 0 6px; }
    .subhead { text-align:center; color:#475569; margin: 0 0 12px; font-size: 0.95em; }

    /* Top controls */
    #topControls { display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin: 10px 0 10px; }
    button { padding:8px 14px; border:none; border-radius:8px; background:#2563eb; color:white; cursor:pointer; }
    button:hover { background:#1e40af; }
    #enableSound { display:none; }
    #resetBoardBtn { display:none; background:#c0392b; }
    #resetBoardBtn:hover { background:#922b21; }

    /* Layout: 2 panels in one row */
    .topRow {
      display:flex;
      gap:14px;
      align-items:flex-start;
    }

    .panel {
      background:white;
      border-radius:12px;
      box-shadow:0 1px 4px rgba(0,0,0,0.08);
      padding:10px;
    }

    /* Make bus panel thinner */
    #busPanel { flex: 0 0 40%; min-width: 320px; }
    #pickupPanel { flex: 1 1 60%; min-width: 420px; }

    .panelTitle {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin: 2px 2px 10px;
    }
    .panelTitle h2 { margin:0; font-size: 1.05em; }
    .panelHint { color:#64748b; font-size: 0.9em; }

    /* Boards */
    .board { display:flex; gap:10px; align-items:flex-start; }

    .column {
      flex:1;
      background:#ffffff;
      border-radius:10px;
      padding:10px;
      min-height: 240px;
      border: 1px solid #e2e8f0;
    }
    .column h3 { text-align:center; margin: 2px 0 10px; font-size: 0.95em; }

    /* Bus tiles */
    .tile { margin:6px 0; padding:10px; border-radius:10px; cursor:grab; transition:transform 0.1s ease; user-select:none; }
    .tile.dragging { opacity:0.5; transform:scale(1.03); }

    .bus { background:#e6f0ff; }
    .student { background:#fff7ed; }

    /* Parking spots: compact columns */
    .spotsWrap { display:flex; gap:10px; flex-wrap:wrap; }
    .spotCol { width: 150px; flex: 0 0 auto; min-height: 160px; }
    .spotBadge {
      display:inline-block;
      font-weight:700;
      padding:4px 10px;
      border-radius:999px;
      background:#e2e8f0;
      color:#0f172a;
    }

    /* Loading overlay */
    #loadingOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(241, 245, 249, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 1.2em;
      color: #2563eb;
      z-index: 1000;
    }
    .spinner {
      border: 4px solid #e0e7ff;
      border-top: 4px solid #2563eb;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      margin-right: 10px;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    @keyframes flash {
      0% { background-color: #fff59d; }
      100% { background-color: inherit; }
    }
    .flash { animation: flash 0.9s ease; }

    /* Small screens: stack panels */
    @media (max-width: 1100px) {
      .topRow { flex-direction: column; }
      #busPanel, #pickupPanel { flex: 1 1 auto; min-width: unset; }
      .spotCol { width: 46%; }
    }
  </style>
</head>

<body>
  <h1>Silent Bus Dashboard ‚Äî Cupples (Live)</h1>
  <div class="subhead">Buses + Parent Pickups (Parking Spots 21‚Äì26)</div>

  <div id="topControls">
    <button id="signInBtn" onclick="signIn()">Sign in with Microsoft</button>
    <button id="enableSound">Enable Sound</button>
    <button id="resetBoardBtn">üîÑ Reset Buses</button>
  </div>

  <div class="topRow">
    <!-- BUS PANEL -->
    <div id="busPanel" class="panel" style="display:none;">
      <div class="panelTitle">
        <h2>üöå Bus Board</h2>
        <div class="panelHint">Drag buses between columns</div>
      </div>

      <div id="busBoard" class="board">
        <div class="column dropzone" id="Not Here"><h3>üöç Not Here</h3></div>
        <div class="column dropzone" id="On Deck"><h3>‚åö On Deck</h3></div>
        <div class="column dropzone" id="Here"><h3>‚úÖ Here</h3></div>
        <div class="column dropzone" id="Gone"><h3>üèÅ Gone</h3></div>
      </div>
    </div>

    <!-- PICKUP PANEL -->
    <div id="pickupPanel" class="panel" style="display:none;">
      <div class="panelTitle">
        <h2>üë®‚Äçüë©‚Äçüëß Parent Pickup</h2>
        <div class="panelHint">Drag student ‚Üí spot. Dropping replaces current name.</div>
      </div>

      <div class="board" style="margin-bottom: 10px;">
        <div class="column dropzone" id="PP-Waiting">
          <h3>üìã Waiting</h3>
        </div>

        <div class="column" style="flex:2;">
          <h3>üöó Parking Spots</h3>
          <div class="spotsWrap">
            <div class="column dropzone spotCol" id="SPOT-21"><h3><span class="spotBadge">21</span></h3></div>
            <div class="column dropzone spotCol" id="SPOT-22"><h3><span class="spotBadge">22</span></h3></div>
            <div class="column dropzone spotCol" id="SPOT-23"><h3><span class="spotBadge">23</span></h3></div>
            <div class="column dropzone spotCol" id="SPOT-24"><h3><span class="spotBadge">24</span></h3></div>
            <div class="column dropzone spotCol" id="SPOT-25"><h3><span class="spotBadge">25</span></h3></div>
            <div class="column dropzone spotCol" id="SPOT-26"><h3><span class="spotBadge">26</span></h3></div>
          </div>
          <div style="color:#64748b; font-size:0.85em; margin-top:8px;">
            Tip: If a spot already has a student, dropping a new name on it will automatically swap them.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- üéµ Sounds -->
  <audio id="dingHere"   src="https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg" preload="auto"></audio>
  <audio id="dingOnDeck" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" preload="auto"></audio>

  <!-- Loading overlay -->
  <div id="loadingOverlay">
    <div class="spinner"></div>
    <span>Refreshing‚Ä¶</span>
  </div>

  <script>
  /***********************
   * CONFIG
   ***********************/
  const msalConfig = {
    auth: {
      clientId: "9fa63e7d-529b-4b31-aeba-240de53122e9",
      authority: "https://login.microsoftonline.com/9c6c3caa-8f3d-4f3c-98f7-e4feea479b7d",
      redirectUri: "https://aaleventhal-lev.github.io/silent-bus-dashboard/"
    },
    cache: { cacheLocation: "localStorage", storeAuthStateInCookie: false }
  };

  const siteUrl = "https://thewatsoninstitute.sharepoint.com/sites/EdCenterSewickleyStaffResourceHub";

  const busListName = "Silent Bus Admin List";
  const pickupListName = "Parent Pickup Board";
  const parkingSpots = ["21","22","23","24","25","26"];

  /***********************
   * AUTH + STATE
   ***********************/
  const msalInstance = new msal.PublicClientApplication(msalConfig);
  const accounts = msalInstance.getAllAccounts();
  if (accounts.length > 0) msalInstance.setActiveAccount(accounts[0]);

  let accessToken = null;
  let soundEnabled = false;

  let busesState = [];
  let pickupsState = [];

  let prevBusStatuses = {};
  let initializedBuses = false;

  const dingHere = document.getElementById("dingHere");
  const dingOnDeck = document.getElementById("dingOnDeck");
  const enableSoundButton = document.getElementById("enableSound");
  const resetButton = document.getElementById("resetBoardBtn");
  const signInBtn = document.getElementById("signInBtn");

  enableSoundButton.addEventListener("click", () => {
    soundEnabled = true;
    enableSoundButton.style.display = "none";
  });

  function showLoading(show, text="Refreshing‚Ä¶") {
    const overlay = document.getElementById("loadingOverlay");
    overlay.querySelector("span").textContent = text;
    overlay.style.display = show ? "flex" : "none";
  }

  /***********************
   * SIGN IN
   ***********************/
  async function signIn() {
    try {
      const loginResponse = await msalInstance.loginPopup({
        scopes: ["User.Read", "Sites.Read.All", "Sites.FullControl.All"]
      });

      msalInstance.setActiveAccount(loginResponse.account);
      const account = msalInstance.getActiveAccount();
      if (!account) throw new Error("No active account found after login");

      const tokenResponse = await msalInstance.acquireTokenSilent({
        scopes: ["https://thewatsoninstitute.sharepoint.com/.default"],
        account
      });

      accessToken = tokenResponse.accessToken;

      // ‚úÖ Hide sign-in button after login
      signInBtn.style.display = "none";

      enableSoundButton.style.display = "inline-block";
      resetButton.style.display = "inline-block";

      document.getElementById("busPanel").style.display = "block";
      document.getElementById("pickupPanel").style.display = "block";

      await refreshAll();
    } catch (error) {
      console.error("Login error:", error);
      alert("Login failed. Open the console (F12) for details.");
    }
  }

  /***********************
   * LOAD DATA
   ***********************/
  async function loadBuses() {
    const endpoint = `${siteUrl}/_api/web/lists/GetByTitle('${busListName}')/items?$select=Id,Title,Status`;
    const res = await fetch(endpoint, {
      headers: { "Authorization": `Bearer ${accessToken}`, "Accept": "application/json;odata=nometadata" }
    });
    if (!res.ok) throw new Error(`Bus list error: ${res.status}`);
    const data = await res.json();

    const oldMap = { ...prevBusStatuses };

    const buses = data.value.map(item => ({
      id: item.Id,
      name: item.Title,
      status: item.Status || "Not Here"
    }));

    if (initializedBuses && soundEnabled) {
      for (const b of buses) {
        const oldStatus = oldMap[b.id];
        const newStatus = b.status;
        if (oldStatus && oldStatus !== newStatus) {
          if (newStatus === "Here") {
            dingHere.pause(); dingHere.currentTime = 0;
            dingHere.play().catch(()=>{});
          }
          if (newStatus === "On Deck") {
            dingOnDeck.pause(); dingOnDeck.currentTime = 0;
            dingOnDeck.play().catch(()=>{});
          }
        }
      }
    }

    prevBusStatuses = {};
    for (const b of buses) prevBusStatuses[b.id] = b.status;
    initializedBuses = true;

    busesState = buses;
    renderBuses(buses, oldMap);
  }

  async function loadPickups() {
    const endpoint = `${siteUrl}/_api/web/lists/GetByTitle('${pickupListName}')/items?$select=Id,Title,Status,Spot,Modified`;
    const res = await fetch(endpoint, {
      headers: { "Authorization": `Bearer ${accessToken}`, "Accept": "application/json;odata=nometadata" }
    });
    if (!res.ok) throw new Error(`Pickup list error: ${res.status}`);
    const data = await res.json();

    pickupsState = data.value.map(item => ({
      id: item.Id,
      name: item.Title,
      status: item.Status || "Waiting",
      spot: item.Spot || null,
      modified: item.Modified ? new Date(item.Modified).getTime() : 0
    }));

    renderPickups(pickupsState);
  }

  async function refreshAll() {
    if (!accessToken) return;
    showLoading(true, "Refreshing boards‚Ä¶");
    try {
      await Promise.all([loadBuses(), loadPickups()]);
    } catch (e) {
      console.error(e);
    } finally {
      showLoading(false);
    }
  }

  /***********************
   * RENDER HELPERS
   ***********************/
  function clearColumn(col) {
    col.querySelectorAll(".tile").forEach(x => x.remove());
  }

  /***********************
   * RENDER: BUSES
   ***********************/
  function renderBuses(buses, oldMap = {}) {
    const statuses = ["Not Here", "On Deck", "Here", "Gone"];
    for (const status of statuses) {
      const col = document.getElementById(status);
      clearColumn(col);

      buses.filter(b => b.status === status).forEach(bus => {
        const div = document.createElement("div");
        div.className = "tile bus";
        div.textContent = bus.name;
        div.draggable = true;

        div.dataset.type = "bus";
        div.dataset.id = bus.id;

        const oldStatus = oldMap[bus.id];
        if (initializedBuses && oldStatus && oldStatus !== bus.status) {
          div.classList.add("flash");
          div.addEventListener("animationend", () => div.classList.remove("flash"));
        }

        div.addEventListener("dragstart", e => {
          e.dataTransfer.setData("text/plain", JSON.stringify({ type: "bus", id: bus.id }));
          div.classList.add("dragging");
        });
        div.addEventListener("dragend", () => div.classList.remove("dragging"));

        col.appendChild(div);
      });
    }
  }

  /***********************
   * RENDER: PICKUPS
   ***********************/
  function renderPickups(students) {
    clearColumn(document.getElementById("PP-Waiting"));
    for (const s of parkingSpots) clearColumn(document.getElementById(`SPOT-${s}`));

    // Waiting = anything not in a spot
    const waiting = students
      .filter(s => !s.spot)
      .sort((a,b) => (a.name || "").localeCompare((b.name || ""), undefined, { sensitivity:"base" }));

    for (const stu of waiting) {
      document.getElementById("PP-Waiting").appendChild(makeStudentTile(stu));
    }

    for (const spot of parkingSpots) {
      const col = document.getElementById(`SPOT-${spot}`);
      const occupant = students.find(s => String(s.spot) === String(spot));
      if (occupant) col.appendChild(makeStudentTile(occupant));
    }
  }

  function makeStudentTile(stu) {
    const div = document.createElement("div");
    div.className = "tile student";
    div.textContent = stu.name;
    div.draggable = true;
    div.dataset.type = "student";
    div.dataset.id = stu.id;

    div.addEventListener("dragstart", e => {
      e.dataTransfer.setData("text/plain", JSON.stringify({ type: "student", id: stu.id }));
      div.classList.add("dragging");
    });
    div.addEventListener("dragend", () => div.classList.remove("dragging"));
    return div;
  }

  /***********************
   * DROP ZONES
   ***********************/
  function initDropZones() {
    document.querySelectorAll(".dropzone").forEach(col => {
      col.ondragover = e => e.preventDefault();
      col.ondrop = async e => {
        e.preventDefault();

        let payload;
        try { payload = JSON.parse(e.dataTransfer.getData("text/plain")); }
        catch { return; }

        if (!payload || !payload.type) return;

        // BUS DROP
        if (payload.type === "bus") {
          const bus = busesState.find(b => String(b.id) === String(payload.id));
          if (!bus) return;

          const targetStatus = col.id;
          if (!["Not Here","On Deck","Here","Gone"].includes(targetStatus)) return;
          if (bus.status === targetStatus) return;

          bus.status = targetStatus;
          renderBuses(busesState, prevBusStatuses);

          if (soundEnabled && targetStatus === "Here") {
            dingHere.pause(); dingHere.currentTime = 0; dingHere.play().catch(()=>{});
          }
          if (soundEnabled && targetStatus === "On Deck") {
            dingOnDeck.pause(); dingOnDeck.currentTime = 0; dingOnDeck.play().catch(()=>{});
          }

          await updateBusItem(bus.id, { Status: bus.status });
          await refreshAll();
          return;
        }

        // STUDENT DROP
        if (payload.type === "student") {
          const stu = pickupsState.find(s => String(s.id) === String(payload.id));
          if (!stu) return;

          const targetId = col.id;

          // Drop into Waiting = clear spot
          if (targetId === "PP-Waiting") {
            stu.spot = null;
            renderPickups(pickupsState);
            await updatePickupItem(stu.id, { Spot: null, Status: "Waiting" });
            await refreshAll();
            return;
          }

          // Drop into a spot column
          if (targetId.startsWith("SPOT-")) {
            const spot = targetId.replace("SPOT-", "");
            if (!parkingSpots.includes(String(spot))) return;

            // ‚úÖ Replacement behavior:
            // If spot occupied by someone else, bump them to Waiting automatically.
            const existing = pickupsState.find(x => String(x.spot) === String(spot) && String(x.id) !== String(stu.id));
            if (existing) {
              existing.spot = null;
              await updatePickupItem(existing.id, { Spot: null, Status: "Waiting" });
            }

            stu.spot = String(spot);
            stu.status = "Waiting"; // keep status consistent
            renderPickups(pickupsState);

            await updatePickupItem(stu.id, { Spot: String(spot), Status: "Waiting" });
            await refreshAll();
            return;
          }
        }
      };
    });
  }

  /***********************
   * SHAREPOINT PATCH
   ***********************/
  async function updateBusItem(id, bodyObj) {
    const endpoint = `${siteUrl}/_api/web/lists/GetByTitle('${busListName}')/items(${id})`;
    const res = await fetch(endpoint, {
      method: "PATCH",
      headers: {
        "Authorization": `Bearer ${accessToken}`,
        "Accept": "application/json;odata=nometadata",
        "Content-Type": "application/json;odata=nometadata",
        "IF-MATCH": "*"
      },
      body: JSON.stringify(bodyObj)
    });
    if (!res.ok) console.error("Bus update failed:", await res.text());
  }

  async function updatePickupItem(id, bodyObj) {
    const endpoint = `${siteUrl}/_api/web/lists/GetByTitle('${pickupListName}')/items(${id})`;
    const res = await fetch(endpoint, {
      method: "PATCH",
      headers: {
        "Authorization": `Bearer ${accessToken}`,
        "Accept": "application/json;odata=nometadata",
        "Content-Type": "application/json;odata=nometadata",
        "IF-MATCH": "*"
      },
      body: JSON.stringify(bodyObj)
    });
    if (!res.ok) console.error("Pickup update failed:", await res.text());
  }

  /***********************
   * RESET BUSES
   ***********************/
  resetButton.addEventListener("click", async () => {
    if (!confirm("Reset all buses to 'Not Here'?")) return;

    try {
      showLoading(true, "Resetting buses‚Ä¶");
      const endpoint = `${siteUrl}/_api/web/lists/GetByTitle('${busListName}')/items?$select=Id`;
      const response = await fetch(endpoint, {
        headers: {
          "Authorization": `Bearer ${accessToken}`,
          "Accept": "application/json;odata=nometadata"
        }
      });
      if (!response.ok) throw new Error(`SharePoint API error: ${response.status}`);

      const data = await response.json();
      for (const item of data.value) {
        await updateBusItem(item.Id, { Status: "Not Here" });
      }

      alert("‚úÖ All buses reset to 'Not Here'.");
      await refreshAll();
    } catch (error) {
      console.error("Error resetting buses:", error);
      alert("‚ùå Reset failed. Check console.");
    } finally {
      showLoading(false);
    }
  });

  /***********************
   * AUTO REFRESH
   ***********************/
  setInterval(async () => {
    const account = msalInstance.getActiveAccount();
    if (account && accessToken) await refreshAll();
  }, 15000);

  // init dropzones once
  initDropZones();
  </script>
</body>
</html>
