<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Silent Bus Dashboard - Cupples (Live)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>
  <style>
    body { font-family: system-ui, "Segoe UI", Arial; background:#f1f5f9; margin:20px; }
    h1 { text-align:center; margin-bottom: 8px; }
    h2 { margin: 18px 0 8px; }
    .subhead { text-align:center; color:#475569; margin-bottom: 18px; }

    .board { display:flex; gap:16px; margin-top:12px; align-items: flex-start; }
    .column { flex:1; background:white; border-radius:10px; padding:12px; min-height:280px; box-shadow:0 1px 4px rgba(0,0,0,0.08); }
    .column h3 { text-align:center; margin: 4px 0 10px; }

    .tile { background:#e6f0ff; margin:6px; padding:10px; border-radius:8px; cursor:grab; transition:transform 0.1s ease; user-select:none; }
    .tile.dragging { opacity:0.5; transform:scale(1.05); }

    /* Parent pickup tiles slightly different */
    .student { background:#fff7ed; }

    button { padding:8px 16px; border:none; border-radius:6px; background:#2563eb; color:white; cursor:pointer; }
    button:hover { background:#1e40af; }

    #login { display:flex; justify-content:center; margin:20px; gap: 10px; flex-wrap: wrap; }
    #enableSound { display:none; margin:10px auto; }

    #resetBoardBtn {
      display:none;
      margin:10px auto;
      background-color:#c0392b;
    }
    #resetBoardBtn:hover { background-color:#922b21; }

    /* tighter columns for parking spots */
    .spotsWrap { display:flex; gap:12px; flex-wrap: wrap; }
    .spotCol { width: 180px; flex: 0 0 auto; min-height: 220px; }
    .spotBadge {
      display:inline-block;
      font-weight:700;
      padding:4px 10px;
      border-radius:999px;
      background:#e2e8f0;
      color:#0f172a;
    }

    /* Loading overlay */
    #loadingOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(241, 245, 249, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 1.2em;
      color: #2563eb;
      z-index: 1000;
    }
    .spinner {
      border: 4px solid #e0e7ff;
      border-top: 4px solid #2563eb;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      margin-right: 10px;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    @keyframes flash {
      0% { background-color: #fff59d; }
      100% { background-color: inherit; }
    }
    .flash { animation: flash 0.9s ease; }
  </style>
</head>

<body>
  <h1>Silent Bus Dashboard â€” Cupples (Live)</h1>
  <div class="subhead">Buses + Parent Pickups (Parking Spots 21â€“26)</div>

  <div id="login">
    <button onclick="signIn()">Sign in with Microsoft</button>
    <button id="enableSound">Enable Sound</button>
    <button id="resetBoardBtn">ğŸ”„ Reset Buses</button>
  </div>

  <!-- BUS BOARD -->
  <h2>ğŸšŒ Bus Board</h2>
  <div id="busBoard" class="board" style="display:none;">
    <div class="column dropzone" id="Not Here"><h3>ğŸš Not Here</h3></div>
    <div class="column dropzone" id="On Deck"><h3>âŒš On Deck</h3></div>
    <div class="column dropzone" id="Here"><h3>âœ… Here</h3></div>
    <div class="column dropzone" id="Gone"><h3>ğŸ Gone</h3></div>
  </div>

  <!-- PARENT PICKUP BOARD -->
  <h2>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Parent Pickup Board</h2>
  <div id="pickupBoard" style="display:none;">
    <div class="board">
      <div class="column dropzone" id="PP-Waiting">
        <h3>ğŸ“‹ Waiting</h3>
      </div>

      <div class="column dropzone" id="PP-Done">
        <h3>âœ… Done</h3>
      </div>
    </div>

    <div style="margin-top:12px;">
      <div style="font-weight:700; margin: 6px 0;">ğŸš— Parking Spots</div>
      <div class="spotsWrap">
        <div class="column dropzone spotCol" id="SPOT-21"><h3><span class="spotBadge">Spot 21</span></h3></div>
        <div class="column dropzone spotCol" id="SPOT-22"><h3><span class="spotBadge">Spot 22</span></h3></div>
        <div class="column dropzone spotCol" id="SPOT-23"><h3><span class="spotBadge">Spot 23</span></h3></div>
        <div class="column dropzone spotCol" id="SPOT-24"><h3><span class="spotBadge">Spot 24</span></h3></div>
        <div class="column dropzone spotCol" id="SPOT-25"><h3><span class="spotBadge">Spot 25</span></h3></div>
        <div class="column dropzone spotCol" id="SPOT-26"><h3><span class="spotBadge">Spot 26</span></h3></div>
      </div>
    </div>
  </div>

  <!-- ğŸµ Sounds -->
  <audio id="dingHere"   src="https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg" preload="auto"></audio>
  <audio id="dingOnDeck" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" preload="auto"></audio>

  <!-- Loading overlay -->
  <div id="loadingOverlay">
    <div class="spinner"></div>
    <span>Refreshingâ€¦</span>
  </div>

  <script>
  /***********************
   * CONFIG
   ***********************/
  const msalConfig = {
    auth: {
      clientId: "9fa63e7d-529b-4b31-aeba-240de53122e9",
      authority: "https://login.microsoftonline.com/9c6c3caa-8f3d-4f3c-98f7-e4feea479b7d",
      redirectUri: "https://aaleventhal-lev.github.io/silent-bus-dashboard/"
    },
    cache: { cacheLocation: "localStorage", storeAuthStateInCookie: false }
  };

  const siteUrl = "https://thewatsoninstitute.sharepoint.com/sites/EdCenterSewickleyStaffResourceHub";

  // Buses
  const busListName = "Silent Bus Admin List";

  // Parent pickups
  const pickupListName = "Parent Pickup Board";
  const parkingSpots = ["21","22","23","24","25","26"];

  /***********************
   * AUTH + GLOBAL STATE
   ***********************/
  const msalInstance = new msal.PublicClientApplication(msalConfig);
  const accounts = msalInstance.getAllAccounts();
  if (accounts.length > 0) msalInstance.setActiveAccount(accounts[0]);

  let accessToken = null;
  let soundEnabled = false;

  // Current items
  let busesState = [];
  let pickupsState = [];

  // For flash/sound comparisons
  let prevBusStatuses = {};
  let initializedBuses = false;

  const dingHere = document.getElementById("dingHere");
  const dingOnDeck = document.getElementById("dingOnDeck");
  const enableSoundButton = document.getElementById("enableSound");
  const resetButton = document.getElementById("resetBoardBtn");

  enableSoundButton.addEventListener("click", () => {
    soundEnabled = true;
    enableSoundButton.style.display = "none";
  });

  function showLoading(show, text="Refreshingâ€¦") {
    const overlay = document.getElementById("loadingOverlay");
    overlay.querySelector("span").textContent = text;
    overlay.style.display = show ? "flex" : "none";
  }

  /***********************
   * SIGN IN
   ***********************/
  async function signIn() {
    try {
      const loginResponse = await msalInstance.loginPopup({
        scopes: ["User.Read", "Sites.Read.All", "Sites.FullControl.All"]
      });

      msalInstance.setActiveAccount(loginResponse.account);
      const account = msalInstance.getActiveAccount();
      if (!account) throw new Error("No active account found after login");

      const tokenResponse = await msalInstance.acquireTokenSilent({
        scopes: ["https://thewatsoninstitute.sharepoint.com/.default"],
        account
      });

      accessToken = tokenResponse.accessToken;

      document.getElementById("login").style.display = "flex";
      enableSoundButton.style.display = "block";
      resetButton.style.display = "block";
      document.getElementById("busBoard").style.display = "flex";
      document.getElementById("pickupBoard").style.display = "block";

      await refreshAll();
    } catch (error) {
      console.error("Login error:", error);
      alert("Login failed. Open the console (F12) for details.");
    }
  }

  /***********************
   * LOAD DATA
   ***********************/
  async function loadBuses() {
    const endpoint = `${siteUrl}/_api/web/lists/GetByTitle('${busListName}')/items?$select=Id,Title,Status`;
    const res = await fetch(endpoint, {
      headers: { "Authorization": `Bearer ${accessToken}`, "Accept": "application/json;odata=nometadata" }
    });
    if (!res.ok) throw new Error(`Bus list error: ${res.status}`);
    const data = await res.json();

    const oldMap = { ...prevBusStatuses };

    const buses = data.value.map(item => ({
      id: item.Id,
      name: item.Title,
      status: item.Status || "Not Here"
    }));

    // Sound on status changes
    if (initializedBuses && soundEnabled) {
      for (const b of buses) {
        const oldStatus = oldMap[b.id];
        const newStatus = b.status;
        if (oldStatus && oldStatus !== newStatus) {
          if (newStatus === "Here") {
            dingHere.pause(); dingHere.currentTime = 0;
            dingHere.play().catch(()=>{});
          }
          if (newStatus === "On Deck") {
            dingOnDeck.pause(); dingOnDeck.currentTime = 0;
            dingOnDeck.play().catch(()=>{});
          }
        }
      }
    }

    // Update map
    prevBusStatuses = {};
    for (const b of buses) prevBusStatuses[b.id] = b.status;
    initializedBuses = true;

    busesState = buses;
    renderBuses(buses, oldMap);
  }

  async function loadPickups() {
    // We pull Modified so â€œrecent changesâ€ could be used later if you want
    const endpoint = `${siteUrl}/_api/web/lists/GetByTitle('${pickupListName}')/items?$select=Id,Title,Status,Spot,Modified`;
    const res = await fetch(endpoint, {
      headers: { "Authorization": `Bearer ${accessToken}`, "Accept": "application/json;odata=nometadata" }
    });
    if (!res.ok) throw new Error(`Pickup list error: ${res.status}`);
    const data = await res.json();

    pickupsState = data.value.map(item => ({
      id: item.Id,
      name: item.Title,
      status: item.Status || "Waiting",
      spot: item.Spot || null,
      modified: item.Modified ? new Date(item.Modified).getTime() : 0
    }));

    renderPickups(pickupsState);
  }

  async function refreshAll() {
    if (!accessToken) return;
    showLoading(true, "Refreshing boardsâ€¦");
    try {
      await Promise.all([loadBuses(), loadPickups()]);
    } catch (e) {
      console.error(e);
    } finally {
      showLoading(false);
    }
  }

  /***********************
   * RENDER: BUSES
   ***********************/
  function clearColumn(col) {
    col.querySelectorAll(".tile").forEach(x => x.remove());
  }

  function renderBuses(buses, oldMap = {}) {
    const statuses = ["Not Here", "On Deck", "Here", "Gone"];
    for (const status of statuses) {
      const col = document.getElementById(status);
      clearColumn(col);

      buses.filter(b => b.status === status).forEach(bus => {
        const div = document.createElement("div");
        div.className = "tile bus";
        div.textContent = bus.name;
        div.draggable = true;

        // drag payload: type + id
        div.dataset.type = "bus";
        div.dataset.id = bus.id;

        const oldStatus = oldMap[bus.id];
        if (initializedBuses && oldStatus && oldStatus !== bus.status) {
          div.classList.add("flash");
          div.addEventListener("animationend", () => div.classList.remove("flash"));
        }

        div.addEventListener("dragstart", e => {
          e.dataTransfer.setData("text/plain", JSON.stringify({ type: "bus", id: bus.id }));
          div.classList.add("dragging");
        });
        div.addEventListener("dragend", () => div.classList.remove("dragging"));

        col.appendChild(div);
      });
    }
  }

  /***********************
   * RENDER: PARENT PICKUPS
   ***********************/
  function renderPickups(students) {
    // Clear waiting + done
    clearColumn(document.getElementById("PP-Waiting"));
    clearColumn(document.getElementById("PP-Done"));

    // Clear each spot column
    for (const s of parkingSpots) clearColumn(document.getElementById(`SPOT-${s}`));

    // Waiting list = Status Waiting and no spot
    const waiting = students
      .filter(s => (s.status || "Waiting") === "Waiting" && !s.spot)
      .sort((a,b) => (a.name || "").localeCompare((b.name || ""), undefined, { sensitivity:"base" }));

    // Done list
    const done = students
      .filter(s => (s.status || "Waiting") === "Done")
      .sort((a,b) => (b.modified || 0) - (a.modified || 0));

    // Assigned to spots
    const assigned = students.filter(s => !!s.spot);

    // Render Waiting
    for (const stu of waiting) {
      document.getElementById("PP-Waiting").appendChild(makeStudentTile(stu));
    }

    // Render Done
    for (const stu of done) {
      document.getElementById("PP-Done").appendChild(makeStudentTile(stu));
    }

    // Render each spot
    for (const spot of parkingSpots) {
      const col = document.getElementById(`SPOT-${spot}`);
      const inThisSpot = assigned
        .filter(s => String(s.spot) === String(spot))
        .sort((a,b) => (a.name || "").localeCompare((b.name || ""), undefined, { sensitivity:"base" }));

      for (const stu of inThisSpot) col.appendChild(makeStudentTile(stu));
    }
  }

  function makeStudentTile(stu) {
    const div = document.createElement("div");
    div.className = "tile student";
    div.textContent = stu.name;
    div.draggable = true;
    div.dataset.type = "student";
    div.dataset.id = stu.id;

    div.addEventListener("dragstart", e => {
      e.dataTransfer.setData("text/plain", JSON.stringify({ type: "student", id: stu.id }));
      div.classList.add("dragging");
    });
    div.addEventListener("dragend", () => div.classList.remove("dragging"));
    return div;
  }

  /***********************
   * DROP HANDLING (BOTH BOARDS)
   ***********************/
  function initDropZones() {
    document.querySelectorAll(".dropzone").forEach(col => {
      col.ondragover = e => e.preventDefault();
      col.ondrop = async e => {
        e.preventDefault();

        let payload;
        try {
          payload = JSON.parse(e.dataTransfer.getData("text/plain"));
        } catch {
          return;
        }
        if (!payload || !payload.type) return;

        // BUS DROP
        if (payload.type === "bus") {
          const bus = busesState.find(b => String(b.id) === String(payload.id));
          if (!bus) return;

          // Only allow dropping onto bus columns (Not Here / On Deck / Here / Gone)
          const targetStatus = col.id;
          if (!["Not Here","On Deck","Here","Gone"].includes(targetStatus)) return;
          if (bus.status === targetStatus) return;

          bus.status = targetStatus;
          renderBuses(busesState, prevBusStatuses);

          if (soundEnabled && targetStatus === "Here") {
            dingHere.pause(); dingHere.currentTime = 0; dingHere.play().catch(()=>{});
          }
          if (soundEnabled && targetStatus === "On Deck") {
            dingOnDeck.pause(); dingOnDeck.currentTime = 0; dingOnDeck.play().catch(()=>{});
          }

          await updateBusItem(bus.id, { Status: bus.status });
          await refreshAll();
          return;
        }

        // STUDENT DROP
        if (payload.type === "student") {
          const stu = pickupsState.find(s => String(s.id) === String(payload.id));
          if (!stu) return;

          const targetId = col.id;

          // Drop into Waiting
          if (targetId === "PP-Waiting") {
            // clear spot, set waiting
            stu.spot = null;
            stu.status = "Waiting";
            renderPickups(pickupsState);
            await updatePickupItem(stu.id, { Spot: null, Status: "Waiting" });
            await refreshAll();
            return;
          }

          // Drop into Done
          if (targetId === "PP-Done") {
            stu.spot = null;
            stu.status = "Done";
            renderPickups(pickupsState);
            await updatePickupItem(stu.id, { Spot: null, Status: "Done" });
            await refreshAll();
            return;
          }

          // Drop into a specific spot column
          if (targetId.startsWith("SPOT-")) {
            const spot = targetId.replace("SPOT-", "");

            // Only allow defined spots 21-26
            if (!parkingSpots.includes(String(spot))) return;

            // Enforce ONE student per spot
            const existing = pickupsState.find(x => String(x.spot) === String(spot) && String(x.id) !== String(stu.id));
            if (existing) {
              alert(`Spot ${spot} is already occupied by "${existing.name}".\n\nMove that student out first, then try again.`);
              return;
            }

            stu.spot = String(spot);
            stu.status = "Waiting"; // stays waiting while assigned to a spot
            renderPickups(pickupsState);

            await updatePickupItem(stu.id, { Spot: String(spot), Status: "Waiting" });
            await refreshAll();
            return;
          }
        }
      };
    });
  }

  /***********************
   * UPDATE SHAREPOINT ITEMS
   ***********************/
  async function updateBusItem(id, bodyObj) {
    const endpoint = `${siteUrl}/_api/web/lists/GetByTitle('${busListName}')/items(${id})`;
    const res = await fetch(endpoint, {
      method: "PATCH",
      headers: {
        "Authorization": `Bearer ${accessToken}`,
        "Accept": "application/json;odata=nometadata",
        "Content-Type": "application/json;odata=nometadata",
        "IF-MATCH": "*"
      },
      body: JSON.stringify(bodyObj)
    });
    if (!res.ok) console.error("Bus update failed:", await res.text());
  }

  async function updatePickupItem(id, bodyObj) {
    const endpoint = `${siteUrl}/_api/web/lists/GetByTitle('${pickupListName}')/items(${id})`;
    const res = await fetch(endpoint, {
      method: "PATCH",
      headers: {
        "Authorization": `Bearer ${accessToken}`,
        "Accept": "application/json;odata=nometadata",
        "Content-Type": "application/json;odata=nometadata",
        "IF-MATCH": "*"
      },
      body: JSON.stringify(bodyObj)
    });
    if (!res.ok) console.error("Pickup update failed:", await res.text());
  }

  /***********************
   * RESET BUSES
   ***********************/
  resetButton.addEventListener("click", async () => {
    if (!confirm("Reset all buses to 'Not Here'?")) return;

    try {
      showLoading(true, "Resetting busesâ€¦");

      const endpoint = `${siteUrl}/_api/web/lists/GetByTitle('${busListName}')/items?$select=Id`;
      const response = await fetch(endpoint, {
        headers: {
          "Authorization": `Bearer ${accessToken}`,
          "Accept": "application/json;odata=nometadata"
        }
      });

      if (!response.ok) throw new Error(`SharePoint API error: ${response.status}`);

      const data = await response.json();
      const items = data.value;

      for (const item of items) {
        await updateBusItem(item.Id, { Status: "Not Here" });
      }

      alert("âœ… All buses reset to 'Not Here'.");
      await refreshAll();
    } catch (error) {
      console.error("Error resetting buses:", error);
      alert("âŒ Reset failed. Check console.");
    } finally {
      showLoading(false);
    }
  });

  /***********************
   * AUTO REFRESH
   ***********************/
  setInterval(async () => {
    const account = msalInstance.getActiveAccount();
    if (account && accessToken) await refreshAll();
  }, 15000);

  // Initialize drop zones immediately
  initDropZones();
  </script>
</body>
</html>
